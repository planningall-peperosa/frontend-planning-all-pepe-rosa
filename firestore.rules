// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ”‘ 1. ACCESSO A TUTTE LE COLLEZIONI DI CONFIGURAZIONE
    // Queste collezioni devono essere leggibili da qualsiasi utente autenticato.
    match /pacchetti_eventi/{docId} {
      allow read: if request.auth != null; 
      // âœ… Abilita Duplica/CRUD per utenti autenticati
      allow create, update, delete: if request.auth != null;
    }
    match /piatti/{docId} {
      allow read: if request.auth != null;
    }
    match /menu_templates/{docId} {
      allow read: if request.auth != null;
    }
    
    // 2. Dati funzionali del Bilancio e Preventivi (come stabiliti in precedenza)
    match /preventivi/{docId} {
      allow read, write: if request.auth != null; 
    }

    // 2b-bis. Contatti creati "al volo" dentro un preventivo (subcollection)
    match /preventivi/{pid}/clienti/{cid} {
      // Leggi/Scrivi consentiti agli utenti autenticati (apre solo questa subcollection).
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      // Se vuoi consentire anche la cancellazione, decommenta la riga seguente:
      // allow delete: if request.auth != null;
    }

    match /spese_categorie/{docCategoria} { 
      allow read, create, write: if request.auth != null; 
    }
    match /users/{userId}/spese_registrate/{docSpesa} {
      allow read, create, write: if request.auth != null && request.auth.uid == userId;
    }

    // 2b. Contatti: CLIENTI (root collection)
    match /clienti/{docId} {
      // Lettura per utenti autenticati
      allow read: if request.auth != null;

      // Creazione: il chiamante deve essere proprietario del documento
      allow create: if request.auth != null
                    && request.resource.data.createdBy == request.auth.uid;

      // Update: solo il proprietario e non puÃ² cambiare il proprietario
      allow update: if request.auth != null
                    && resource.data.createdBy == request.auth.uid
                    && request.resource.data.createdBy == resource.data.createdBy;

      // Delete: solo il proprietario (request.resource Ã¨ null nei delete)
      allow delete: if request.auth != null
                    && resource.data.createdBy == request.auth.uid;
    }

    // 2c. Contatti: FORNITORI (root collection)
    match /fornitori/{docId} {
      allow read: if request.auth != null;

      allow create: if request.auth != null
                    && request.resource.data.createdBy == request.auth.uid;

      allow update: if request.auth != null
                    && resource.data.createdBy == request.auth.uid
                    && request.resource.data.createdBy == resource.data.createdBy;

      allow delete: if request.auth != null
                    && resource.data.createdBy == request.auth.uid;
    }
    
    // 3. Regola di fallback generica (solo lettura per gli utenti)
    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Disabilita la scrittura non specificata
    }
  }
}
